<!DOCTYPE html>
<html xmlns:sec="" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>chat</title>
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <!-- 부가적인 테마 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
    <!-- 합쳐지고 최소화된 최신 자바스크립트 -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
</head>
<body>
<script>


</script>

<span id="userName" sec:authentication="name"></span>님 게임시작합니다.
<label for="roomId" class="label label-default">방 번호</label>
<label th:text="*{room.roomId}" id="roomId" class="form-inline"></label>
<br>
<label for="roomName" class="label label-default">방 이름</label>
<label th:text="*{room.name}" id="roomName" class="form-inline"></label>
<br>
<label for="roomName" class="label label-default">방 인원 수</label>
<label th:text="*{room.roomUserCount}" id="roomUserCount" class="form-inline"></label>
<br>

<div>

    <table border="0" cellpadding="0" cellspacing="0" id="board" >
        <tr>
            <td><button class="btn btn-primary" id="send" onclick="sendNumber(1)">1</button></td>
            <td><button class="btn btn-primary" id="send" onclick="sendNumber(2)">2</button></td>
            <td><button class="btn btn-primary" id="send" onclick="sendNumber(3)">3</button></td>
            <td><button class="btn btn-primary" id="send" onclick="sendNumber(4)">5</button></td>
            <td><button class="btn btn-primary" id="send" onclick="sendNumber(5)">5</button></td>
            <td><button class="btn btn-primary" id="send" onclick="sendNumber(6)">6</button></td>
            <td><button class="btn btn-primary" id="send" onclick="sendNumber(7)">7</button></td>
        </tr>
        <tr>
            <td><button class="btn btn-primary" id="send" onclick="sendNumber(11)">1</button></td>
            <td><button class="btn btn-primary" id="send" onclick="sendNumber(12)">2</button></td>
            <td><button class="btn btn-primary" id="send" onclick="sendNumber(13)">3</button></td>
            <td><button class="btn btn-primary" id="send" onclick="sendNumber(14)">4</button></td>
            <td><button class="btn btn-primary" id="send" onclick="sendNumber(15)">5</button></td>
            <td><button class="btn btn-primary" id="send" onclick="sendNumber(16)">6</button></td>
            <td><button class="btn btn-primary" id="send" onclick="sendNumber(17)">7</button></td>
        </tr>
    </table>
</div>

<div id="chatroom" style="width:400px; height: 600px; border:1px solid; background-color : gray"></div>
<input type="text" id="message" style="height : 30px; width : 340px" placeholder="내용을 입력하세요" autofocus>
<button class="btn btn-primary" id="send">전송</button>

<div id="chatGame" style="width:400px; border:1px solid; background-color : gray"></div>





</body>
<script th:inline="javascript">
    let webSocket;
    /* <![CDATA[*/
    let roomId = /*[[${room.roomId}]]*/;
    /* ]]> */
    const userNm = document.getElementById('userName').innerHTML;
    connect();
    document.getElementById("send").addEventListener("click", function () {
        send();
    })

    function sendNumber(number) {
        webSocket.send(JSON.stringify({chatRoomId: roomId, type: 'GAME', writer: userNm, message: number}));
    }

    function connect() {
        webSocket = new WebSocket("ws://localhost:8080/chat");
        webSocket.onopen = onOpen;
        webSocket.onclose = onClose;
        webSocket.onmessage = onMessage;
    }

    function disconnect() {
        webSocket.send(JSON.stringify({chatRoomId: roomId, type: 'LEAVE', writer: userNm}));
        webSocket.close();
    }

    function send() {
        const msg = document.getElementById("message").value;
        webSocket.send(JSON.stringify({chatRoomId: roomId, type: 'CHAT', writer: userNm, message: msg}));
        document.getElementById("message").value = "";
    }

    function onOpen() {
        webSocket.send(JSON.stringify({chatRoomId: roomId, type: 'ENTER', writer: userNm}));
    }

    function onMessage(e) {
        // const data = JSON.parse(e.data);
        console.log(e);

        /**
         *
         *

         switch(msg.type) {
            case "id":
              clientID = msg.id;
              setUsername();
              break;
            case "username":
              text = "<b>User <em>" + msg.name + "</em> signed in at " + timeStr + "</b><br>";
              break;
            case "message":
              text = "(" + timeStr + ") <b>" + msg.name + "</b>: " + msg.text + "<br>";
              break;
            case "rejectusername":
              text = "<b>Your username has been set to <em>" + msg.name + "</em> because the name you chose is in use.</b><br>"
              break;
            case "userlist":
              var ul = "";
              for (i=0; i < msg.users.length; i++) {
                ul += msg.users[i] + "<br>";
          }
          document.getElementById("userlistbox").innerHTML = ul;
          break;
        }

         if (text.length) {
    f.write(text);
    document.getElementById("chatbox").contentWindow.scrollByPages(1);
  }


         *

         const data = JSON.stringify(e.data);
         if (data.indexOf("GR^^")) {
            // var tempData = data.replace("GAME^^","")
            // chatroom.innerHTML = chatroom.innerHTML + "<br>" + tempData;

            document.getElementById("roomUserCount").value = "";

        } else {
            const chatroom = document.getElementById("chatroom");
            chatroom.innerHTML = chatroom.innerHTML + "<br>" + data;
        }
         */
    }

    function onClose() {
        disconnect();
    }

</script>
</html>