<!DOCTYPE html>
<html xmlns:sec="" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>채팅 서비스</title>
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <!-- 부가적인 테마 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
    <!-- 합쳐지고 최소화된 최신 자바스크립트 -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
</head>
<body>
<script>


</script>

<span id="userName" sec:authentication="name"></span>님 게임시작합니다.
<label for="roomId" class="label label-default">방 번호</label>
<label th:text="*{room.roomId}" id="roomId" class="form-inline"></label>
<br>
<label for="roomName" class="label label-default">방 이름</label>
<label th:text="*{room.name}" id="roomName" class="form-inline"></label>
<div id="chatroom" style="width:400px; height: 600px; border:1px solid; background-color : gray"></div>
<input type="text" id="message" style="height : 30px; width : 340px" placeholder="내용을 입력하세요" autofocus>
<button class="btn btn-primary" id="send">전송</button>



<div id="chatGame" style="width:400px; height: 600px; border:1px solid; background-color : gray"></div>

<button class="btn btn-primary" id="send" onclick="javascript:sendNumber(1)">전송1</button>
<button class="btn btn-primary" id="send" onclick="javascript:sendNumber(2)">전송2</button>
<button class="btn btn-primary" id="send" onclick="javascript:sendNumber(3)">전송3</button>
<button class="btn btn-primary" id="send" onclick="javascript:sendNumber(4)">전송4</button>
<button class="btn btn-primary" id="send" onclick="javascript:sendNumber(5)">전송5</button>

</div>


</body>
<script th:inline="javascript">
    let webSocket;
    /* <![CDATA[*/
    let roomId = /*[[${room.roomId}]]*/;
    /* ]]> */

    const userNm = document.getElementById('userName').innerHTML;

    connect();

    document.getElementById("send").addEventListener("click", function () {
        send();
    })

    function sendNumber(number) {
        webSocket.send(JSON.stringify({chatRoomId: roomId, type: 'GAME', writer: userNm, message: number}));
    }

    function connect() {
        webSocket = new WebSocket("ws://localhost:8080/chat");
        webSocket.onopen = onOpen;
        webSocket.onclose = onClose;
        webSocket.onmessage = onMessage;
    }

    function disconnect() {
        webSocket.send(JSON.stringify({chatRoomId: roomId, type: 'LEAVE', writer: userNm}));
        webSocket.close();
    }

    function send() {
        const msg = document.getElementById("message").value;
        webSocket.send(JSON.stringify({chatRoomId: roomId, type: 'CHAT', writer: userNm, message: msg}));
        document.getElementById("message").value = "";
    }

    function onOpen() {
        webSocket.send(JSON.stringify({chatRoomId: roomId, type: 'ENTER', writer: userNm}));
    }

    function onMessage(e) {
        const data = e.data;
        if (data.indexOf("GAME^^")) {
            var tempData = data.replace("GAME^^","")
            chatroom.innerHTML = chatroom.innerHTML + "<br>" + tempData;
        } else {
            const chatroom = document.getElementById("chatroom");
            chatroom.innerHTML = chatroom.innerHTML + "<br>" + data;
        }
    }

    function onClose() {
        disconnect();
    }

</script>
</html>